---
title: "Effects of bariatric surgery and weight loss on resting state functional connectivity"
author:
- Hannah Sophie Heinrichs* [1]
- Frauke Beyer* [1][2]
- Kerstin Prehn
- Agnes Floel
- Arno Villringer [1][2][3]
- A. Veronica Witte [1][2][3]
date: 1 Max-Planck-Institute for Human Cognitive and Brain Sciences, Leipzig \newline
  2 CRC 1052 "Obesity Mechanisms", Subproject A1, University of Leipzig \newline 3
  Day Clinic for Cognitive Neurology, University Clinic Leipzig
output:
  bookdown::pdf_book:
    fig_caption: yes
    always_allow_html: true
    number_sections: yes
    toc: yes
    extra_dependencies: "subfig"
bibliography: "bibliography.bib"
editor_options:
  chunk_output_type: console
---

```{r "To do", include=FALSE}

# [ ] Evaluate SPM model comparison (more activation in SPM..)
# [ ] Discussion
# [ ] hervorheben, was von Präregistrierung abweicht
# [ ] brain images mit nilearn plotting tools einbinden
# [ ] Upload auf Neurovolt, cf. cobidas reporting guidelines
# [ ] re-do analysis with new sample
# [ ] repeat analysis with exclusion of 10% of worst data
# [ ] Network tests

```

```{r "load packages", include=FALSE}

# load packages
library(car) # version 3.0.9
library(plyr) # version 1.8.6
library(dplyr) # version 1.0.2
library(tidyr) # version 1.1.2
library(kableExtra) # version 1.2.1
library(ggplot2) # version 3.3.2
library(patchwork) # version 1.0.1; API for sequentially building up a plot (similar to gridExtra and cowplot)
library(cowplot)
library(RColorBrewer) # version 1.1.2
library(psych) # version 2.0.8
#library(lsr)
#library(wesanderson) # colour palette
#library(haven)

library(lme4)
library(sjPlot)

library(knitr) # version 1.30
```

```{r "knit setup", include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE) # fig.height=2, fig.width=4)
options(knitr.table.format = "latex")
# set working directory of knit (RMarkdown) to directory of Rproj
opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
setwd(knitr::opts_knit$get("root.dir"))
```
\newpage
# Abstract

\newpage
# Introduction




<!-- obesity and interventions -->
Over the past decades, the global burden of obesity has increasingly been confronted as a matter of urgency by research.
_something about comorbidities_
Besides metabolic dysfunctions, obesity has been consistently associated with reduced gray matter volume, less intact white matter structure and reduced cognitive function [@Beyer_2019; @Zhang_2018].
Luckily, dietary interventions such as caloric restriction and related metabolic improvements, and weight loss have been suggested to improve neuronal plasticity and cognitive performance [@Witte_2009; @Zhang_2018; @Veronese_2017].
In some cases behavioral intervention fail to yield the desired success regarding weight loss. There are non-behavioral alternatives at hand.
<!-- bars most invasive (brain metabolism), last resort -->
Bariatric surgery is one promising option to combat morbid obesity, as it rapidly improves weight status, metabolic dysfunctions, and co-morbidities, such as diabetes [@]. Roux-en-Y gastric bypass (RYGB) is the most common procedure as it not only restricts the food intake by reducing stomach volume but also affects the absorption of macronutrients and the hormonal profile [@]. <!-- ref for "common", ref for procedure -->
Other widely used procedures are vertical sleeve gastrectomy (VSG) and gastric banding (GB) which only restrict food consumption. <!-- mehr zu Veränderung in Gasto-intestinaler Physiologie -->

<!-- Neural mechanisms/concurrent plasticity? -->
Precise mechanisms are yet to be elucidated. As a first step, a comprehensive understanding of the concurrent physiological changes underlying weight loss and recovery is needed. This will inform inferences about potential mechanisms and either support interventions proven to be effective or ideally allow imitating them will less invasive alternatives.

Recently, research focuses have slowly shifted to investigate brain metabolism structural and functional changes after surgery.
<!-- severe nutritional stress [@Crujeiras_2017] -->

<!-- Reward network -->
Little is known about the potential beneficial effects of bariatric surgery on brain function in the obese population, in particular with regard to hedonic motivations for food, which play a fundamental role in weight relapse.
<!-- mechanism reward and appetite, overating -->
Besides malabsorption and restricted food ingestion, patients report post-surgical changes in food preferences and eating behavior. Those psychophysiological and behavioral effects may be related to post-surgical changes in visceral sensory perceptions and endocrinological signaling. Corresponding information is processed by the fronto-mesolimbic system and affects appetite and reward signalling which may influence weight regulation [@Mulla_2017, @Nudel_2019].
<!-- results in lean -->
The reward network entailing the ventromedial prefrontal cortex (vmPFC), the striatum (STR) but also the anterior insula (antIns) has been linked to food valuation processes in decision-making in lean individuals [@Bartra_2013; @Hare_2011; @Hutcherson_2012; @Schmidt_2018; @Wiemerslage_2016].
<!-- results in obese longitudinal -->
Similarly, several studies have found differences in resting-state activity in reward regions depending on weight status.

Obese individuals exhibited increased connectivity between frontal and mesolimbic regions and weaker connectivity within regions of the mesolimbic system (encompassing limbic and striatal regions). These differences seemed to normalize, as trends reversed when looking at the resting state of obese individuals after compared to before the surgery [@Duan_2020].

On the other hand, BMI prior to the surgery was associated with changes in connectivity [@Duan_2020].

s concerning such processes following a surgical intervention are inconclusive.

<!-- important differences in the response to visual food-related cues between thin and reduced-obese individuals that place the latter group at an increased risk of  -->

<!-- Though there exists strong evidence for important differences in the .. between lean or normal-weight individuals and obese individuals, few studies have investigated the ... and even fewer compared reduced-obese individuals reduced-obese individuals -->
<!-- [@Garcia_Garcia_2012] -->

<!-- Default mode network -->
Weight regulation and energy expenditure is dependent on a complex interplay of external and internal sensory processing, as well as molecular homeostasis regulation. Obesity may be cause or effect of a decompensation of the psychophysiological system that ensures homeostasis.
The default mode network is commonly associated with processing of self-referent as well as introspective information, such as hunger sensation [@;@] and appetite [@Tregellas_2011]. <!-- parietal activation correlated with appetite measures after an overnight fast [@Tregellas_2011]. --> It is mainly composed of the posterior cingulate cortex (PCC)/precuneus, the medial prefrontal cortex (MPFC) and inferior and lateral parietal cortex (IPC, LPC; approx. BA 39) [@Raichle_2015]. The right ventral anterior cingulate cortex (VACC), superior frontal cortex (SFC), and inferior temporal cortex (ITC) show weaker but also reliable association with the PCC over the course of one year. Even broader conceptions count left VACC, middle temporal gyrus (MTG), and parahippocampal cortex, although associations with the PCC are not as stable [@Chou_2012].
<!-- difference lean obese -->
Functional connectivity of this network has been shown to be linked to BMI [@Beyer_2017] and altered after bariatric surgery [@Olivo_2016]. Generally, studies show an increased activation in the default mode network, especially in the precuneus and posterior cingulate cortex (PCC) in obese individuals [@Kullmann_2011; @].
A longitudinal study that confirmed the stronger connectivity (of PCC with anterior STG and anterior temporal fusiform gyrus and the Precuneus with the anterior STG). However, default mode connectivity in these regions seemed weakened over the course of one year. Because differences between lean controls and obese individuals that existed prebariatric surgery were no longer detectable 1 year after the surgery, the authors argue for a normalization in functional connectivity<!-- and PCC/PC connectivity with anterior STG are most affected by the surgery -->[@Olivo_2017].
This is consistent with other findings of reduction of functional connectivity of these and other regions of the default mode network, such as the VMPFC [@Li_2018] <!-- with the dorsolateral prefrontal cortex (DLPFC) --> after the surgery.

The exact mechanisms of how bariatric surgery affects functional plasticity needs to be investigated. Among patients undergoing surgery, change in BMI was negatively correlated with the changes in connectivity of the default mode network, namely between the PCC/precuneus and the DLPFC [@Li_2018].

On the other hand, connectivity also served as a predictor of weight loss after surgery.

On the other hand, there are also indicators of reduced functional integrity, e.g. for the anterior cingulate cortex (ACC) at resting state compared to lean individuals [@Kullmann_2011].


<!-- novelty statement --> As described previously, several studies have investigated the effects of bariatric surgery on the intrinsic functional connectivity in patients. Yet, to our knowledge there is no quasi-experimental study, comparing a cohort of patients to a cohort with similar characteristics but unexposed to the intervention, i.e. bariatric surgery, over an extended time period as would be demanded to draw more substantiated inference [@George_2016].
<!-- hypotheses --> In this study, we aim to bridge this gap and investigate possible dynamics of within-reward network connectivity before and after bariatric surgery by comparison with a contemporaneously measured waiting-control group. Moreover, we will explore whether the changes in functional connectivity are associated with the amount of weight lost after bariatric surgery treatment in obesity to explore a potential gradient link. In addition, we will investigate potential changes in within-network functional connectivity after surgery in other resting-state networks such as default mode network (DMN).
Participants are measured at baseline, at 6 months and at 24 months to capture both phases of rapid weight-loss and maintenance as expected from non-surgical interventions [@Shai_2008].

<!-- group effect because direct effect of intervention surgery -> rsfmri (cares lessfreq, less preoccupation with hunger, less/more reward sensitivity) vs. sugery -> BMI -> rsfmri (neural signalling, fatty tissue) -->


\newpage
# Methods

```{r Load data, include=FALSE}
source("code/create_sample_df.R")
final = create_sample_df(group = "all", tp = "all")

# sample size
#nrow(subj_df)
subj_idx <- match(unique(final$subj.ID), final$subj.ID) # indices of first row of each subject
subj_df <- final[subj_idx,] # df with unique subjects

# completed time points
freqtable <- as.data.frame(table(final$subj.ID))
tpfreq <- table(freqtable$Freq)

# overview distribution of data points
tp1 <- as.character(freqtable$Var1[freqtable$Freq == 1])
tp2 <- as.character(freqtable$Var1[freqtable$Freq == 2])
tp3 <- as.character(freqtable$Var1[freqtable$Freq == 3])
tp1_tab <- table(subset(final, subj.ID %in% tp1)$tp, subset(final, subj.ID %in% tp1)$condition)
tp2_tab <- table(subset(final, subj.ID %in% tp2)$tp, subset(final, subj.ID %in% tp2)$condition)[c(1,3),]
tp3_tab <- table(subset(final, subj.ID %in% tp3)$tp, subset(final, subj.ID %in% tp3)$condition)[1,]
total_datapoints <- c(sum(final$group==1),sum(final$group==2))
total_subjects <- plyr::count(final[subj_idx,"group"])$freq
tab_sample <- data.frame(rbind(tp1_tab, tp2_tab, tp3_tab, total_subjects, total_datapoints))
rm(tp1,tp2,tp3,tp1_tab, tp2_tab, tp3_tab, total_subjects, total_datapoints)
rownames(tab_sample) <- c("count: only 0","count: only 6","count: only 12","count: 0 and 6","count: 6 and 12","count: complete data","total number of subjects","total data points")
colnames(tab_sample) <- c("BARS","NBARS")

# distribution of condition and sex
subj_df$Sex <- plyr::mapvalues(subj_df$Sex, from = c("-1", "1"), to = c("f", "m"))
cs <- addmargins(table(subj_df$Sex,subj_df$condition))

dfw <- tidyr::pivot_wider(data = final,
                          id_cols = c("subj.ID","condition","Sex","Age_BL"),
                          names_from = "tp",
                          values_from = c("BMI","meanFD"))
```

```{r tableSample, echo=FALSE}
tab_sample <-
  knitr::kable(
    tab_sample,
    row.names = TRUE,
    format = "latex",
    booktabs = T,
    caption = "Distribution of data points at months after intervention")
tab_sample
```

## Sample and study design

<!-- STUDY DESIGN --> The ADIPOSITAS-Study conducted in the Charité Berlin is a observational, prospective and longitudinal design described in detail by @Prehn_2020. Data collection is still ongoing but only data available in April 2019 is used.
The procedures followed were in accordance with the Helsinki Declaration. This study was registered at clinicaltrials.gov as NCT01554228 and described in more detailed in the preregistration under [https://osf.io/mzyxv](https://osf.io/mzyxv).
<!-- RECRUITEMENT, INCLUSION/EXCLUSION CRITERIA --> Participants were recruited from the Center for Bariatric and Metabolic Surgery if they were between age $18$ and $70$ and fulfilled the inclusion criteria. These were, in accordance with BARS guidelines, a failure of conservative obesity treatment and either (1) a BMI $> 40$ km/m$^2$ or (2) a BMI $> 35$ kg/m$^2$ and at least one typical co-morbidity (e.g. type-2 diabetes, hypertension, non-alcoholic fatty liver disease)[@Mechanick_2013].
Participants with a history of cancer, chronic inflammatory disease and addiction, other severe untreated diseases, brain pathologies identified in the MRI scan or cognitive impairments (MMSE score $< 34$) were excluded from the study. <!-- Frage: Ausschluss bei head movement? ADI009_fu2 nicht enthalten (siehe Readme preprocessing) -->
Measures were taken at baseline (BL), $6$ (FU1) and $12$ (FU2) months post-surgery or after the baseline appointment but not all participants have complete data for all time points (see Table \@ref(tab:tableDescr)). `r sum(freqtable$Freq == 3)` participants had complete data, `r sum(freqtable$Freq == 2)` provided data for two time points and `r sum(freqtable$Freq == 1)` for only one time point.
The current sample is the subsample of $69$ subjects that were originally enrolled in the study entailing only subjects that have received MRI. Analyses were performed on all participants that provided at least one data point of fMRI data (detailed information on data availability in \@ref(tab:tableSample)).

<!-- DESCRIPTIVE STATISTICS --> The final sample entailed morbidly obese individuals (n = `r nrow(subj_df)`, `r nrow(filter(subj_df,Sex == "f"))` female; ages `r round(mean(subj_df$Age_BL),2)` $\pm$ `r round(sd(subj_df$Age_BL),2)` SD years (range `r min(subj_df$Age_BL)`-`r max(subj_df$Age_BL)`), that either underwent surgery (n = `r cs["Sum","KG"]`, `r cs["f","IG"]` female) or were waiting list controls (n = `r cs["Sum","KG"]`, `r cs["f","KG"]` female). The study design was quasi-experimental, as patient in the waiting control list had also been recommended to undergo bariatric surgery, but were still waiting for their health insurance's approval.

```{r tableBaselineCharacteristics, include=FALSE}
dfBL <- create_sample_df(group = "all", tp = "BL")

# distributions per group
# BMI
p <- ggplot(data=dfBL, aes(group = condition, x=BMI, fill=condition)) +
  geom_density(alpha=0.6) +
  scale_fill_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")) +
  theme_bw()
# log mean FD
p <- ggplot(data=dfBL, aes(group = condition, x=logmFD, fill=condition)) +
  geom_density(alpha=0.6) +
  scale_fill_manual(
    values = c("#00305E55", "#C0004555"),
    labels = c("intervention", "control")) +
  theme_bw()
# Age
p <- ggplot(data=dfBL, aes(group = condition, x=Age_BL, fill=condition)) +
  geom_density(alpha=0.6) +
  scale_fill_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")) +
  theme_bw()

tab_age <- psych::describeBy(data=dfBL, x=dfBL$Age_BL, group=dfBL$condition, mat=T)

# Sex
p <- ggplot(data = dfBL, aes(x = condition, fill = Sex)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(labels = c("female", "male"),
                    values = c("#00305E55", "#C0004555")
  )
tab_sex <- table(dfBL$condition, dfBL$Sex)
```
Histograms on baseline characteristics revealed, that patients in the control group did not differ notably from the intervention group regarding BMI and log mean FD, and only slightly in distribution of sex and age, the control group had a higher number of male participants (n = `r tab_sex[2,2]` vs. n = `r tab_sex[2,1]`) and a higher mean age (`r round(tab_age$mean[tab_age$group1=="KG"],2)` vs. `r round(tab_age$mean[tab_age$group1=="IG"],2)`). Change in BMI throuout the study is depicted in \@ref(fig:figBMIdescr).
<!-- SURGICAL PROCEDURE --> As intervention, $0$ participants received surgery that combines restrictive and malabsorptive mechanisms (RYGB) and $0$ surgery purely restricting energy intake (VSG: n = $0$, GB: n = $0$).
```{r tableDescr, echo=FALSE}

# table for descriptive statistics
descr <- psych::describeBy(dfw[,5:ncol(dfw)], group=dfw$condition,mat=T)
descr$predictor <- c(rep("BMI",6),rep("meanFD",6))
descr$tp <- car::recode(descr$vars, "c(1,4)='fu2';c(2,5)='fu';c(3,6)='bl'")
descr$group <- descr$group1
descr <- descr[,c("predictor","tp","group","n","mean","sd")]
descr <- descr[with(descr, order(predictor, tp)),]
descr[,c("mean","sd")] <- round(descr[,c("mean","sd")],2)
descr[c(2:6,8:12),"predictor"] <- ""
descr[c(2,4,6,8,10,12),"tp"] <- ""
rownames(descr) <- NULL

tab_descr <-
  knitr::kable(
    descr,
    row.names = FALSE,
    format = "latex",
    booktabs = T,
    caption = "BMI and mean FD of participants acquired in each condition and time point")

tab_descr

```
<!-- STUDY PROCEDURE -->
Subjects arrived in the morning (between 07:00 and 12:00) after an overnight fast. They underwent medical assessments including an interview, blood draw and anthropometric measurements before having a one our break for STANDARDIZED?? breakfast. MRI scanning was done after further psychological tests (for details see @Prehn_2020).

```{r figBMIdescr, fig.align='center', out.width="90%", fig.cap="BMI over time.", echo=FALSE}
# eval = TRUE, fig.asp = 0.7, fig.width = 6
condition.labs <- c("BARS","NBARS")
names(condition.labs) <- c("IG","KG")
# BMI over time each group
figBMIdescr <-
  ggplot(final, aes(
    x = tp,
    y = BMI,
    group = subj.ID,
    color = condition
  )) +
  geom_line() + geom_point() +
  stat_summary(
    aes(group = condition),
    fun = mean,
    geom  = "line",
    size = 2,
    color = c(rep("#00305E", 3), rep("#C00045", 3))
  ) +
  facet_grid(. ~ condition, labeller = labeller(condition=condition.labs)) + xlab("time points")
figBMIdescr +
  scale_x_discrete(labels = c("bl" = "0", "fu" = "6", "fu2" = "12")) +
  scale_color_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")
  ) +
  xlab("Time after intervention [months]") + ylab ("BMI [kg/m²]") +
  theme_bw() +  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.position = "none"
  )
```

## fMRI acquisition

MRI images were retrieved with a 12-channel head coil of a 3 Tesla Trio, Siemens (Erlangen) with syngo B17 software.
<!-- MRI --> T1-weighted anatomical images were acquired as described in @Prehn_2020 (with MPRAGE, repetition time (TR) = 1900 ms, echo time (TE) = 2.52 ms, flip angle = 9°, voxel size = 1 x 1 x 1 mm$^3$, 192 sagital slices).
<!-- rsfMRI --> Resting state echo-planar imaging  was acquired with a TR of 2.3 s and TE of 30 ms. The image matrix was 64 x 64 with an in-plane resolution of 3 mm x 3 mm and 34 slices with a slice thickness of 4 mm. 150 volumes were acquired, resulting in a total acquisition time of 5:45 minutes. Additionally, a gradient echo field map with a TE difference of 2.46 ms was acquired to correct for field inhomogeneties.
Participants were instructed to close their eyes but to remain awake during scanning.

## Pre-proceessing

Imaging data was conducted using AFNI 19.1.05, ANTS '2.3.1', FSL '6.0.1' and FreeSurfer '6.0.0p1', wrapped in a nipype workflow (version 1.2.0) in Python 2.7.15.
The preprocessing workflow included modules to process anatomical, functional and diffusion-weighted imaging in parallel. The workflow can be found on [github](https://github.com/fBeyer89/ADI_preproc/).

### Anatomical preprocessing
Within the module for anatomical preprocessing, the T1-weighted images were first processed by FreeSurfer's cross-sectional pipeline [@fs_cross]. Then, Freesurfer's longitudinal stream was applied to all cross-sectional runs [@fs_long]. Here, white matter (WM) and cerebral spinal fluid (CSF) masks were derived based on FreeSurfer's `aseg.mgz` segmentation file for quality control of rs preprocessing.  
The skull-stripped brain (`brainmask.mgz`) was then coregistered to the MNI152 1x1x1x mm template using ANTS [@antsref]. The following parameters were used for rigid [metric: mutual information, number of iterations: [1000, 500, 250, 100]], affine [metric: mutual information, number of iterations: [1000, 500, 250, 100]] and SyN: [metric: cross-correlation, iterations: [100, 70, 50, 20]] registration steps with shrink factors [8, 4, 2, 1], and smoothing sigmas=[3, 2, 1, 0] for each step.
In the preregistration it was only mentioned that longitudinal FreeSurfer would be used, but no details regarding the exact analysis.


## Functional preprocessing
### Minimal functional preprocessing
The function preprocessing module included the removal of first four volumes, motion correction (FSL's `MCFLIRT`), fieldmap distortion correction (FSL's `fsl_prepare_fieldmap` and `FUGUE`) and coregistration to the subject’s individual longitudinal anatomical space (FreeSurfer's `bbregister`). In more detail, the transformations derived from the latter three steps were combined into one and applied in a single step.
For further analysis and ICA-AROMA processing, the minimally preprocessed data were intensity normalized and smoothed with a 6mm Gaussian kernel (`fslmaths -kernel gauss 2.548`).
*This part of the analysis was described in the preregistration as "After removing the first four volumes, transforms for motion correction (FSL’s MCFLIRT), fieldmap distortion correction (based on fieldmap and FSL’s FUGUE) and coregistration to the subject’s individual anatomical space (using FREESURFER’s bbregister) are calculated."*  

### ICA-AROMA preprocessing   
We used ICA-AROMA for fMRI denoising as it provides an acceptable trade-off between the mitigation of motion-FC correlation and the introduction of a distance-dependence on motion-FC relationship [@Parkes_2018]. As described in [@Pruim2015], the minimally preprocessed data was processed with independent component analysis (ICA) using FSL's `melodic` and nuisance components were classified according to four spectral and spatial criteria. Finally, the timeseries of the  nuisance components were regressed from the raw fMRI timeseries.
As recommended in the original paper, we performed regression of WM and CSF signal on the ICA-AROMA result. We used CompCor to estimate 5 variance components from a combined WM and CSF mask, which was further eroded using `fslmaths -nan -thr 0.99 -ero -bin` [@Behzadi_2007;@Muschelli_2014]. After regression of these nuisance components from the data, we performed high-pass filtering at 0.01 Hz.
*This analysis was described in the preregistration as "Then we will employ state-of-the art nuisance regression (i.e. ICA-AROMA with compCor regression (CC) and, optionally global signal regression (GSR) (Ciric et al., 2017; Parkes et al., 2018) to reduce the effect of physiological noise and head motion on the connectivity estimates."*  


### Global Signal regression   
[@Ciric_2017] showed that GSR is very efficient in removing the correlation of head motion and FC, and outperforms ICA-AROMA alone. Yet, it introduces spatial dependency and spurious correlations. Previously, we reported on head motion differences between groups over time in this study [@Beyer_2020], and thus it was very important to minimize the motion-FC correlation. The global signal was derived from the average of all voxels in the brain mask. Then, we regressed WM and CSF CompCor components along with the GS from the ICA-AROMA fMRI data and high-pass filtered the resulting file as above.
*In the preregistration we stated " As global signal regression is very efficient in removing the correlation of head motion and connectivity dependence, but introduces spatial dependency and spurious correlations, we perform GSR after ICA-AROMA in a separate sensitivity analysis."*

### Functional connectivity
To derive reward and DMN functional connectivity maps, we used Nucleus Accumbens (Nacc) and precuneus as seed regions of interest (ROI), respectively. Based on FreeSurfer's `aseg.mgz` and Desikan-Killiany parcellation, we created seed masks using `mri_binarize` (thresholded for NAcc at 26,58; precuneus at 1025,2025) and averaged them over hemispheres. Then, we used `NiftiLabelsMasker` and `NiftiMasker` to extract the standardized timeseries from the seed regions and the whole brain. We calculated the Pearson's correlation between them with `numpy.dot`, performed r-to-z transform and saved the resulting correlation maps for each processing mode (minimally preprocessed, aroma+cc, aroma+gsr). Finally, the connectivity maps were transformed into MNI space using the affine transformation and non-linear warp derived with ANTS during anatomical preprocessing.
*In the preregistration we stated "Resting-state functional connectivity (FC) using seed-based connectivity analysis extracted with in-house pre-processing pipelines (see (Beyer et al., 2019)): Whole-brain FC maps for a priori defined seed regions (defined based on the results of the subcortical segmentation and Desikan-Killiany cortical parcellation in the Freesurfer version 6.0.0 longitudinal processing stream). For the reward network a ROI combined from bilateral Nucleus accumbens from the subcortical segmentation (26, Left-Accumbens-area, 58, Right-Accumbens-area) was selected. Ventro-medialprefrontal cortex was not selected as seed region due to low signal-to-noise ratio in this part of the brain in many participants (noticed during quality checking). For the default mode network, the seed region was combined from bilateral precuneus from the Desikan-Killiany atlas (1025 ctx-lh-precuneus, 2025 ctx-rh-precuneus). We will calculate  voxel-wise seed-based connectivity mapsin the individual subject’s space (which is coregistered to the Freesurfer longitudinally preprocessed timepoint) and apply r-to-Z-transform to these images. These steps will be performed using nilearn, nipype and python. Then, we will transform the connectivity maps into MNI space with a non-linear warp derived from anatomical preprocessing of the longitudinally preprocessed timepoints (using ANTS).*

### Quality Assessment

#### Anatomical Quality control

FreeSurfer cross-sectional and longitudinal  segmentations were visually checked according to @Klapwijk_2019. We excluded 5 datasets from 3 participants because of excessive head motion leading to failed pial reconstruction and anatomical-functional coregistration .
<!--ADI009_fu2, ADI063_bl, ADI063_fuADI116_bl, ADI116_fu, ADI116_fu2-->
*In the preregistration we stated that "Freesurfer segmentations and surfaces will be visually controlled and corrected according to published recommendations, if necessary", and that "We will exclude participants in which head motion artifacts affected the T1-weighted image preprocessing (e.g. caused Freesurfer to fail or perform very poorly (rated “Failed” according to (Klapwijk et al., 2019)".*

#### Functional Quality control
Resting state fMRI data quality control was performed along the protocol of @Ciric_2018.
As the expected average head motion is high in this sample [@Beyer_2020], it is difficult to determine an appropriate exclusion threshold which does not lead to the exclusion of a high number of individuals. Thus, we did not exclude any participants based on mean framewise displacement estimates beyond those who failed the anatomical preprocessing. We applied best-practice motion correction (ICA-AROMA and CC, plus optionally GSR) and monitored the reduction of motion-related artifact according to current recommendations [@Ciric_2018]. In addition, for models showing a significant group-by-time interaction, we performed a sensitivity analysis excluding the 10% data sets with highest mean FD (mFD).
On the single-subject level, we used `plot_carpet` from `niworkflows.viz.plots` to generate carpet plots which depict denoising quality. Figure \@ref{carpet_plot} shows an exemplary carpet plot with (from top to bottom): DVARS (spatial root mean square of the data after temporal differencing), mFD, percent outliers defined by AFNI `OutlierCount`, voxelwise timeseries from minimally preprocessed, AROMA non-aggressive and aggressive denoising, CC and CC + GSR data. All carpet plots were visually checked and if there was still structured noise in the CC+GSR-denoised functional data (such as black/white stripes, signal dropout), the participant was given a rating of 1 in `QA residuals`.
We evaluated mFD-FC relationships by computing a functional connectome based on (Power et al., 2011). In more detail, we used the MNI coordinates of 246 cortical and subcortical spherical seed regions with 5mm radius in `NiftiSpheresMasker`, and calculated the Spearman rank correlation between these time series. Then, we correlated mean FD and QC values for each node across participants, and plotted the resulting mFD-FC correlation values in histogram (see Figure \@ref{example_FC}. We reported the mFD-FC correlation per preprocessing scheme.
Further, we evaluated the distance-dependence of mFD-FC correlations by correlating the euclidean distance between nodes with the mFD-QC correlation and report mean, median and standard deviations of mFD, DVARS and number of outliers over all participants.

### Aggregated FC values
To extract aggregated FC values, we first calculated the mean DMN and reward networks over all participants and time points, adjusted for age and sex. We used the modified SwE option and used global signal regressed data as input. Network masks were formed from all voxels with a clusterwise $p_{FWE} < 0.05$ and we extracted the average connectivity from these masks for all data points.

<!-- param.ROI_PREP = {roi_prep{[6,14]}}; % {roi_prep{[4, 6, 12, 14, 20, 22, 28, 30]}} or {'Nacc_cc_z','Nacc_gsr_z','PCC_cc_z','PCC_gsr_z','LH_cc_z','LH_gsr_z','MH_cc_z','MH_gsr_z'} -->
<!-- % Model definition -->
<!-- % All three models have unique options for covariate definition, the -->
<!-- % association to a model is indicated by the tens digit (GroupTime_: 1_;  -->
<!-- % BMI_ = 2_; FD_ = 3_) the specific covariate combination by the ones digit -->
<!-- param.MODEL = {'alltp'}; % {'grouptime','grouptime2tp'} % {'bmi','bmiIG','bmi2tp'} % {'fd','fdIG'} % {'alltp'} % {'singletp}  -->
<!-- param.COVARIATES = [41];     % [11, 12];                    % [21, 22];                % [31, 32];  % [41, 42]    % [41, 42, 43] -->

<!-- % define masking and type of inference -->
<!-- param.MASK = 'brain';               % 'brain' -->
<!-- param.EXCLFD = false;               % false -->
<!-- param.WILD_BOOT = false;            % false -->
<!-- param.INFERENCE_TYPE = {'cluster'}; % {'voxel','cluster','tfce'}; -->

*In the preregistration we wrote: "We will use the average of connectivity values within masks of the respective networks as aggregate network connectivity measure. The mask will include all voxels surviving FWE-correction of p<0.05 in a one-sample t-test of the individual connectivity maps across all participants and time points, calculated with the modified SwE option in the SwE toolbox"*


<!-- MOTION CORRECTION We therefore apply best-practice motion correction (ICA-AROMA and CC, plus optionally GSR) and monitor the reduction of motion-related artifact according to current recommendations [@Ciric_2018]. As quality checks statistical analysis were performed on both with and without global signal regression, considering the controversial discussion about GSR introducing negative correlations and spatial bias into connectivity data [@Ciric_2017; @Murphy_2017].
Additionally, mean framewise displacement (FD) was extracted from 6 translational/rotational motion parameters of the whole time series according to @Power_2012, log-transformed and examined within and separate from the main models.  -->


## Analysis

Statistical analysis were performed in MATLAB version 9.7.0.1190202 (R2019b) using the development version of the SwE toolbox [@Guillaume_2014] ([https://github.com/NISOx-BDI/SwE-toolbox](https://github.com/NISOx-BDI/SwE-toolbox) as of commit #384d2d7944e0c1919a3d22a0282a513916c25f59 was used because of bugs in most recent release) as implemented in SPM12.7770<!-- spm_check_installation('rev') -->, and R version 3.6.1 [@team2013r].
During analyses an implicit mask and an explicit mask were used. For this, FSL's standard space the brain mask that corresponds th "152 nonlinear 6th generation" atlas was re-sampled to 3 x 3 x 3 mm$^3$.<!-- MNI ICBM 2009a Nonlinear Symmetric grey matter mask ([http://www.bic.mni.mcgill.ca/ServicesAtlases/ICBM152NLin2009](http://www.bic.mni.mcgill.ca/ServicesAtlases/ICBM152NLin2009)) were re-sampled to 3 x 3 x 3 mm$^3$ and binarized at threshold $0.5$. -->

<!-- MODEL SETUP --> As specified in the preregistration, we tested the interaction of time and group: $FC = group + time + group*time$. Unlike prespecified, we did not include the model without covariates (as this is deprecated \@ref{nuisance_paper}). Instead, we calculated a model adjusting for age and sex (Model 1) and another model additionally adjusting for mean FD (Model 2). We did not adjust for baseline BMI as described in the preregistration, but explored the relationship with BMI in a separate analysis.
These were examined each for correlation maps of two different seed regions (NAcc / PCC), and for the purpose of comparison for correlation maps of two different preprocessing pipelines (only AROMA+CC / with GSR)), with two different covariate sets (with/ without mean FD), resulting in $16$ a priori planned analyses.
Initially, analyses were run with a brain mask but after post hoc considerations detailed below, models were re-run with a grey matter mask which reduced the number of tests (voxels of interest) from $52378$ to $29451$. As a result a total of $32$ different analyses were performed.
Computation with the grey matter mask were exploratory and deviate from the preregistration.
The second model on the influence of between-subject differences in average BMI and longitudinal within-subject change in BMI was specified as follows: $FC = between-subject BMI + within-subject BMI$.

<!-- MODEL SPECIFICATION --> The marginal model implemented via the SwE toolbox implicitly accounts for random effects without the need to specify them through the error term. It therefore accommodates any repeated measurement covariance structures. <!-- Prereg: During the model specification, we will select the modified sandwich estimator (SwE) approach. Thus, we will define the groups and visits as binary numeric values and subject IDs as numeric values, matching the input order of the images. -->We used a modified SwE assuming different covariance structures for the intervention and the control group because of their unbalanced sample size, so heteroscedasticity would be considered.

<!-- DESIGN MATRIX, vielleicht beide auch als Abbildung kurz zeigen? --> For the first model, time was introduced as factor because we did not assume strict linearity for the increase in connectivity and therefore refrained from modeling time as continuous variable (see Figure \@ref(fig:figDesignmatrix)). The resulting factorial design <!-- check: flexible factorial? --> contained one regressor for each time point per group.
```{r figDesignmatrix, fig.align = 'center', fig.ncol = 2, out.width = "50%", fig.subcap=c('Design matrix with time as categorial factor.','Design matrix with time as continuous variable.'), fig.cap="Possible design matrices of group-time model.", echo=FALSE}
# fig.show="hold",  out.width="40%", fig.height = 8,

# design matrix time as factor
txt_path <- "/data/pt_02161/Analysis/Project2_resting_state/seed-based/Second_level /SwE_files/noExclFD/both/total/"

ID <- read.delim(paste0(txt_path,"subjID.txt"), head=FALSE)
condition <- read.delim(paste0(txt_path,"group.txt"), head=FALSE)
KG_bl <- read.delim(paste0(txt_path,"KG_bl.txt"), head=FALSE)
KG_fu <- read.delim(paste0(txt_path,"KG_fu.txt"), head=FALSE)
KG_fu2 <- read.delim(paste0(txt_path,"KG_fu2.txt"), head=FALSE)
IG_bl <- read.delim(paste0(txt_path,"IG_bl.txt"), head=FALSE)
IG_fu <- read.delim(paste0(txt_path,"IG_fu.txt"), head=FALSE)
IG_fu2 <- read.delim(paste0(txt_path,"IG_fu2.txt"), head=FALSE)
measurement <- c(1:nrow(ID))
dmf <- data.frame(measurement,ID,condition,KG_bl,KG_fu,KG_fu2,IG_bl,IG_fu,IG_fu2)
colnames(dmf) <- c("measurement","ID","condition","N0","N6","N12","B0","B6","B12")

# design matrix time as continuous variable
ID <- read.delim(paste0(txt_path,"subjID.txt"), head=FALSE)
condition <- read.delim(paste0(txt_path,"group.txt"), head=FALSE)
group_IG <- read.delim(paste0(txt_path,"group_IG.txt"), head=FALSE)
group_KG <- read.delim(paste0(txt_path,"group_KG.txt"), head=FALSE)
tp_IG <- read.delim(paste0(txt_path,"tp_IG.txt"), head=FALSE)
tp_KG <- read.delim(paste0(txt_path,"tp_KG.txt"), head=FALSE)
measurement <- c(1:nrow(ID))
dmc <- data.frame(measurement,ID,condition,group_IG,group_KG,tp_IG,tp_KG)
colnames(dmc) <- c("measurement","ID","condition","groupB", "groupN","timeB","timeN")

# plot dmf
input_dmf <- dmf %>%
  pivot_longer(
    cols= colnames(dmf[,c(4:ncol(dmf))]),
    names_to = "regressor")
input_dmc <- dmc %>%
  pivot_longer(
    cols= colnames(dmc[,c(4:ncol(dmc))]),
    names_to = "regressor")

plotA <- ggplot(input_dmf, aes(x = regressor, y = measurement, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low="black", high="white") +
  labs(x="regressors", y="scans") +
  # design
  scale_x_discrete(expand = c(0,0),labels=colnames(dmf)[4:ncol(dmf)]) +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() + theme(legend.position = "none",
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12))
# + theme(panel.grid = element_blank(),
#         panel.border = element_rect(colour = "black", size=1),
#    legend.text = element_text(size = 10)
#         plot.title=element_text(size=11))
plotB <- ggplot(input_dmc, aes(x = regressor, y = measurement, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low="black", high="white") +
  labs(x="regressors", y="scans") +
  # design
  scale_x_discrete(expand = c(0,0),labels=colnames(dmc)[4:ncol(dmc)]) +
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() + theme(legend.position = "none",
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12))
# + theme(panel.grid = element_blank(),
#         panel.border = element_rect(colour = "black", size=1),
#    legend.text = element_text(size = 10)
#         plot.title=element_text(size=11))

plotA
plotB
#gridExtra::grid.arrange(plotA, plotB, nrow=1)
```
For the second and third model, we calculated the centered mean BMI and log mean FD per subject and the intra-subject-centered BMI as proposed by @Guillaume_2014. With a model containing average BMI and longitudinal change per subject, we investigated their differential effects on the complete sample and subsequently in a exploratory fashion for the intervention group only as the effect of longitudinal change in BMI was expected to be driven by this subsample.
<!-- NUISANCE COVARIATES --> Age at baseline, sex, and log mean framewise displacement (FD) were entered into the first and second model as nuisance variables. Age and sex were between-subject covariates while FD is time-varying. Mean FD was log-transformed and age was demeaned by subtracting the overall mean across subjects and time points.
<!-- Prereg: We will perform sensitivity analysis adjusting for baseline age, sex, average of mean FD of both time points and baseline BMI -->
As change in FD and change in BMI share common variance [@Beyer_2019], the inclusion of log mean FD may be disputed and done optionally. For that reason, we performed each analysis separately one with mean FD (three and without. Differences in results will be reported. We consider this sensitivity analysis theoretically more meaningful than the preregistered comparison with the nuisance covariate free model and a model with four nuisance covariates (including baseline BMI).
<!-- POST HOC  --> For a better understanding of the unique contribution of average and longitudinal change FD measures, we employed a third post-hoc model to disentangle the effects: $FC = between-subject FD + within-subject FD$. These post-hoc analyses deviate from the preregistration and should be considered to be exploratory.
<!-- INFERENCE --> <!-- Prereg: We will use Type 3 small samples bias adjustment and “Approx” option for estimating the degrees of freedom. We will use the Non-Parametric Wild Bootstrap approach with default parameters, 5000 bootstraps and clusterwise inference (cluster forming threshold of p<0.01). Significant clusters are defined as family-wise error - corrected p<0.05. -->
To ensure robustness of our results, we computed estimates with non-parametric test using Wild bootstrap with an unrestricted SwE on all contrasts of interest for clusterwise inference. Type C2 for small sample bias adjustment is applied before the bootstrap resampling as recommended in the SwE manual. In contrast to the parametric estimation, Wild Bootstrap avoids any parametric distributional assumptions (e.g. random field theory), and is unlike permutation based framework appropriate<!-- permutations don't work with multilevel data (dependencies)--> for longitudinal data.
Unlike the description in the preregistration, we used a cluster forming threshold of $p < 0.001$ for a more multiple comparison adjustment (instead of $p < 0.01)$, and $1000$ bootstraps due to required computation time (instead of 5000). Significant clusters are defined as family-wise error (FWE) corrected $p < 0.05$.

<!-- R analysis of aggregated values -->
We analyzed the aggregate connectivity values using linear mixed models in the R package lme4.
Following the preregistration, we first investigated a time-by-group interaction between baseline and followup.
We used a model comparison of R1 and R0 models with `anova`:
`R1= lmer(agg FC ~ timepoint*group + (1|subj))`
`R0 = lmer(agg FC ~ timepoint + group + (1|subj))`
We performed a sensitivity analysis adjusting for baseline age, sex, average of mean FD of both time points and baseline BMI. Again, the group-by-time point interaction was considered significant if a model comparison between R1 and Null models using anova-function yielded a p<0.05.
Finally, we estimated the above-mentioned interaction model for all three time points. Again, the interaction was considered significant if a model comparison between R1 and R0 using `anova` had p<0.05.

# Results

## Quality control
We performed different quality controls for the rsfMRI data.
As described in @Beyer_2020, there was a significant interaction of group and time on mFD. In particular, the intervention group reduced in head motion in the follow-up assessments compared to the control group.
We also inspected DVARS, a measurement of whole-brain variation in signal which is often reflective of noise in the data. We saw that DVARS did not qualitatively differ between groups and timepoints, and that the correlation of DVARS and mFD remained similar over time points.
This indicates that even though there was a decrease in head motion in the intervention versus control group, the impact of head motion on imaging data remained similar over the study period.
```{r tableQA, fig.cap="Summary table of QA measures"}
for (i in 1:nrow(final)) {
  tmp = strsplit(toString(final[i, "scan_dir"]), '/')[[1]][8]
  conf = read.csv(
    paste0("/data/pt_02161/preprocessed/resting/detailedQA/metrics/",tmp,"/confounds.csv")
  )
  tmp = cor.test(conf$DVARS, conf$FD)
  final[i, "corr_DVARS_FD"] = tmp$estimate
  final[i, "mean_DVARS"] = mean(conf$DVARS, na.rm = TRUE)
  final[i, "max_DVARS"] = max(conf$DVARS, na.rm = TRUE)
  final[i, "mean_outliers"] = mean(conf$outliers, na.rm = TRUE)
}

```

```{r figDvarsmFD, fig.align = "center", out.width="100%", fig.cap='Summary of quality measures DVARS and mFD'}
# ,  fig.align='center', }
# eval = TRUE, fig.asp = 0.7, fig.width = 6
condition.labs <- c("BARS","NBARS")
names(condition.labs) <- c("IG","KG")

# DVARS over time each group
fig_DVARSdescr <-
  ggplot(final, aes(
    x = tp,
    y = mean_DVARS,
    group = subj.ID,
    color = condition
  )) +
  geom_line() + geom_point() +
  stat_summary(
    aes(group = condition),
    fun = mean,
    geom  = "line",
    size = 2,
    color = c(rep("#00305E", 3), rep("#C00045", 3))
  ) +
  facet_grid(. ~ condition, labeller = labeller(condition=condition.labs)) + xlab("time points")
fig1=fig_DVARSdescr +
  scale_x_discrete(labels = c("bl" = "0", "fu" = "6", "fu2" = "12")) +
  scale_color_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")
  ) +
  xlab("Time [months]") + ylab ("Mean DVARS") +
  theme_bw() +  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.position = "none"
  )
# mFD over time each group
fig_mFDdescr <-
  ggplot(final, aes(
    x = tp,
    y = meanFD,
    group = subj.ID,
    color = condition
  )) +
  geom_line() + geom_point() +
  stat_summary(
    aes(group = condition),
    fun = mean,
    geom  = "line",
    size = 2,
    color = c(rep("#00305E", 3), rep("#C00045", 3))
  ) +
  facet_grid(. ~ condition, labeller = labeller(condition=condition.labs)) + xlab("time points")
fig2=fig_mFDdescr +
  scale_x_discrete(labels = c("bl" = "0", "fu" = "6", "fu2" = "12")) +
  scale_color_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")
  ) +
  xlab("Time [months]") + ylab ("mFD in mm") +
  theme_bw() +  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.position = "none"
  )
# DVARS-FD over time each group
fig_mFDDVARSdescr <-
  ggplot(final, aes(
    x = tp,
    y = corr_DVARS_FD,
    group = subj.ID,
    color = condition
  )) +
  geom_line() + geom_point() +
  stat_summary(
    aes(group = condition),
    fun = mean,
    geom  = "line",
    size = 2,
    color = c(rep("#00305E", 3), rep("#C00045", 3))
  ) +
  facet_grid(. ~ condition, labeller = labeller(condition=condition.labs)) + xlab("time points")
fig3=fig_mFDDVARSdescr +
  scale_x_discrete(labels = c("bl" = "0", "fu" = "6", "fu2" = "12")) +
  scale_color_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")
  ) +
  xlab("Time [months]") + ylab ("DVARS-FD correlation") +
  theme_bw() +  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.position = "none"
  )

(fig1 | fig2) / fig3

```

```{r FDFC correlation, eval=FALSE, echo=FALSE}
source("/data/pt_02161/Analysis/Preprocessing/qa/rs_qa/group_level_QA/QC_FC_correlations/calc_qc_fc_correlations.R")

FDFC=calc_qc_fc(final)
write.csv(FDFC,"./report/FDFCcorrelations.csv", row.names = FALSE)
```

```{r tableQcfc, echo=FALSE}
res <- read.csv("./report/FDFCcorrelations.csv")
rownames(res) <- c("minimally processed", "AROMA", "AROMA + CC", "AROMA + CC + GSR")
colnames(res) <- c('mean FD-QC', 'median FD-QC', 'sig. vertex', 'sig. vertex BH', 'distance-FD-QC', 'pval')

tab_qc_fc <-
  knitr::kable(
    round(res,3),
    col.names = colnames(res),
    row.names = TRUE,
    format = "latex",
    booktabs = T,
    caption = "Summary of quality metrics for different denoising pipelines across conditions and time points")

tab_qc_fc
```

Further, we evaluated the impact of our denoising pipelines. Table \@ref(tab:tableQcfc) shows that in the minimally preprocessed data, mFD and connectivity was significantly positively correlated (mean Spearman's r = `r round(res[1,1],2)`), with a strong distance dependence (mean Spearman's r = `r round(res[1,5],2)`).  Denoising procedures (AROMA, AROMA+CC, AROMA+CC+GSR) gradually reduced the correlation of mFD and connectivity, and also alleviated the distance dependency. AROMA+CC+GSR performed best, with almost no mFD-FC correlation (mean Spearman's r = `r round(res[4,1],2)`), and minimal positive distance dependence (mean Spearman's r = `r round(res[4,5],2)`). Yet, AROMA+CC also performed well, and we thus calculated our analysis models for both preprocessing schemes.

## Interaction effect of intervention and time (preregistered analysis)

### DMN/reward network with whole brain mask (preregistered analysis)

#### with adjustment for age, sex, meanFD
<!-- Brain mask: Group*Time Interaction [CORRECTED] -->
There was no interaction of group and time point regarding the resting state connectivity for neither the PCC nor the NAcc as was hypothesized. Nor was there a significant main effect for any of the covariates of interest (time, group) in clusterwise inference with FWE correction.

#### with adjustment for age and sex
Similarly, there were only non-findings when reducing the number of nuisance covariates by leaving out mean FD, no connectivity was found between the PCC with one other voxel.
Results did not differ between analyses of connetivity maps from different preprocessing pipelines.
<!-- There was no other significant co-activation for any other region of interest for neither of the preprocessing variants. -->

<!-- Neurovault -->
Unthresholded maps for the t-tests as well as contrasts of average BMI and change BMI of the main model, and post-hoc contrasts for average FD and change FD will be are published on NeuroVault.

### DMN/reward network with GM mask (exploratory analysis)
<!-- GM mask: Group*Time Interaction [OLD]-->
Parametric and non-parametric significance test for the model testing for group-time-interaction did not show any different results when using a grey matter mask. Again, parametric estimation and non-parametric estimation differed in regard to the group-time-interaction of PCC and voxel ($18,42,30$) in the connectivity maps without GSR correction. While co-activation was significant in parametric estimation ($Z = 4.72$, $q_{FDRcorr} = 0.040$), it was non-significant when using wild bootstrap ($q_{\mathrm{FDRcorr}} = 0.998$)<!-- also FWE-corr n.s -->.

## Interaction effect group by time on aggregated FC (preregistered analysis)

### DMN for two timepoints
```{r calc DMN two tp, eval = FALSE, echo = FALSE}
R1 = lme4::lmer(DMN_FC ~ timepoint*group + (1|subj))
R0 = lme4::lmer(DMN_FC ~ timepoint + group + (1|subj))
```
### DMN for two timepoints, adjusted for age, sex, mean FD
```{r calc DMN two tp adjusted, eval = FALSE, echo = FALSE}
R1 = lme4::lmer(DMN_FC~ timepoint*group + age + sex + meanFD (1|subj))
R0 = lme4::lmer(DMN_FC ~ timepoint + group + age + sex + meanFD (1|subj))
```
### DMN for three timepoints, adjusted for age, sex, mean FD
```{r calc DMN three tp, eval = FALSE, echo = FALSE}
R1 = lme4::lmer(DMN_FC~ timepoint*group + age + sex + meanFD (1|subj))
R0 = lme4::lmer(DMN_FC ~ timepoint + group ++ age + sex + meanFD (1|subj))
```

### reward
```{r calc rew two tp, eval = FALSE, echo = FALSE}
R1 = lme4::lmer(rew_FC ~ timepoint*group + (1|subj))
R0 = lme4::lmer(rew_FC ~ timepoint + group + (1|subj))
```
### reward for two timepoints, adjusted for age, sex, mean FD
```{r calc rew two tp adjusted, eval = FALSE, echo = FALSE}
R1 = lme4::lmer(DMN_FC ~ timepoint*group + age + sex + meanFD (1|subj))
R0 = lme4::lmer(DMN_FC ~ timepoint + group + age + sex + meanFD(1|subj))
```
### reward for three timepoints, adjusted for age, sex, mean FD
```{r calc rew three tp, eval = FALSE, echo = FALSE}
R1 = lmer(DMN_FC ~ timepoint*group + age + sex + meanFD (1|subj))
R0 = lmer(DMN_FC ~ timepoint + group + age + sex + meanFD (1|subj))
```


## Effect of mean and change in BMI (exploratory analysis)

<!-- Brain mask: average and individual BMI [OLD] -->
<!-- BMItotal --> Next, we tested for significant effects of the average BMI and the individual change in BMI longitudinally across the three time points. There was no significant co-activation for neither the PCC nor the NAcc associated with average BMI nor change in BMI.
Omitting mean FD as nuisance covariate did not change these results.
<!-- BMIonlyIG --> Upon inclusion of only a subsample entailing participants from the intervention group but not the waiting control group, there was still no effect for average BMI, but a significant effect of change in BMI on co-activation between the seed region NAcc and a voxel ($-18,-42,-9$ [mm])<!-- belonging to a cluster of $k = 2$ --> with $Z = 4.64$ ($p_{FWEcorr} = 0.049$) (in GSR corrected connectivity maps). However the effect did not survive recalculation with Wild bootstrap ($p_{FWEcorr} = 0.426$)<!-- but FWE-corr sig?! -->. The effect also disappeared when running those tests without mean FD as nuisance covariate.
<!-- BMI2tp --> Running the tests on a subsample of only two time points and omitting data from the third did not yield any significant co-activation with the ROI for neither of the preprocessing variants. Omitting mean FD did not change these results.

<!-- GM mask: average and individual BMI, damit die Reihenfolge so ist wie oben. -->
Results obtained from analyses with the grey matter masks were equal to those reported for the brain masks except test statistics for the above reported significant longitudinal effect for the NAcc in the intervention group differed only marginally ($q_{FDRcorr} = 0.048$) and did not survive recalculation with Wild bootstrap either ($q_{FDRcorr} = 0.552$).
In regard to the exploratory expeditions on subsamples, consistent with previous results, no significant co-activation was found when using the grey matter mask.

## Effect of FD (exploratory analysis)

<!-- Brain mask: FD --> To investigate the unique contributions of the average value of and the longitudinal change in mean FD, we constructed a model that entailed both of the predictors as covariates of interest and only age and sex as nuisance covariates.
Surprisingly, there was no significant effect neither for the total sample, nor for the intervention group only.
<!-- GM mask: FD --> Similarly, analysis with the grey matter mask did not reveal any findings either.

## Effect on hypothalamic connectivity (exploratory analysis)

<!-- Brain mask: FD --> To investigate the unique contributions of the average value of and the longitudinal change in mean FD, we constructed a model that entailed both of the predictors as covariates of interest and only age and sex as nuisance covariates.
Surprisingly, there was no significant effect neither for the total sample, nor for the intervention group only.
<!-- GM mask: FD --> Similarly, analysis with the grey matter mask did not reveal any findings either.

# Discussion

<!-- SUMMARY -->
Utilizing resting-state functional MRI on morbidly obese individuals that either underwent or awaited bariatric surgery over the course of one year.
<!-- general --> Building on the evidence for post-surgery changes in functional activity, this study explored the longitudinal relationship between surgery-induced weight loss and functional integrity in target networks indicated by resting-state functional connectivity. Over the course of one year we collected neuroimaging and anthropometric data from `r cs["Sum","IG"]` morbidly obese patients undergoing bariatric surgery and compared them to the longitudinal data of  `r cs["Sum","KG"]` patients on the waiting list.
<!-- model specific --> With the model on group-time-interaction, we primarily investigated whether changes in functional connectivity over time vary depending whether participants have received surgery or not, while controlling for individual variance in resting-state connectivity over time and at baseline. Beyond that, also main effects of the intervention and of the time were examined. <!-- correct interpretation of marginal models? -->
The second model further investigates if changes in connectivity are a function of an average BMI (controlled for individual variance in BMI) and the longitudinal change in BMI.

<!-- SUPPORT OF ORIGINAL HYPOTHESIS -->
<!-- false positive -->
To summarize, there were few significant co-activation that emerged from the marginal models. Co-activation was locally highly specific and (NOT???) in accordance with our hypothesis regarding network activity changes. Given the multiplicity of of models resulting from variations of inspected networks and sensitivity analysis for different preprocessing and correction approached, the obtained significant correlations between seed regions and voxels are likely to be false positive. Ventures to verify effects by re-calculating with non-parametric Wild bootstrap confirmed supported presumption as effects were not robust across estimation procedures.
<!-- limitations -->
Without an a priori power analysis it is not possible to determine if there is no effect or
To clarify, extended considerations should be made to use a priori power analysis (e.g. with fMRIpower) or check evidence of absence with alternative

<!-- SIMILARITY OF RESULTS -->
Our results are not consistent with the present literature. Although there are few studies investigating the impact of bariatric surgery on functional connectivity at resting state, the present articles do significant changes in network activation [@;@;@].
<!-- publication bias -->

<!-- INTERPRETATION -->
<!-- absence of evidence --> However, hypotheses about the plasticity functional networks following bariatric surgery could not be validated. Due to the shortcomings of the inferential paradigm used, our null findings may either put conclusions drawn from previous research into question or may neither provide evidence for the presence nor the absence of the effect.
<!-- Control for satiety? --> A previous repeated measurement design with patients undergoing bariatric surgery and behavioral dietary intervention manipulating satiety showed a differential effect of satiety between intervention groups on the resting-state functional connectivity seeded in the precuneus. After the intervention, the functional connectivity was higher in bariatric patients. It decreased after a meal while dietary patients showed an increase [@Lepping_2015].
prandrial state is a relevant factor when investigating spontaneous brain activity [@Wiemerslage_2016]. putamine, insula

<!-- GENERALIZABILITY -->
<!-- advantage: prospective intervention control study -->
Common challenge in medical intervention studies is the difficulty to draw causal inference about the effect of interventions such as surgeries because randomization is often unethical or unfeasible as done in randomized control trials. To isolate the effect of the surgical intervention to a maximum possible extent, the intervention group has to be comparable to a control group in regard  to predisposition. Studies comparing the sample of bariatric patients to lean individuals or behavioral dieters may have investigated risk or contributing factors to the condition or other dispositional difference between groups, e.g. in cognitive control, openness or responsiveness to behavioral interventions [@;@]. However, they provide insufficient evidence to directly evaluate impact of the surgical procedure. Prospective non-randomization trial study design are secondary to randomized control trials in regard to internal control. By establishing temporality, longitudinal measurements support the validity of conclusions about the effects of the surgery. Contrasting pre- and post-surgery measures change while controlling for individual variance. The waiting list control group equivalent in BMI, treatment history and  treatment recommendation allows controlling for concurrent factors [@Thiese_2014]. Incorporating these consideration, our study aimed at a higher internal validity for conclusions about the effects of bariatric surgery on functional connectivity.

<!-- advantage: Nucleus Accumbensrepresentative sample -->
Size and composition of our sample did not allow separate analyses for the sexes. The disproportionate sex distribution is reflective prevalence differences and under-utilization of bariatric surgery by men [@Fuchs_2015; @Chooi_2019].

<!-- mention larger sample size -->

<!-- mixed effect model -->
Due to the limitation of the traditional ANOVA framework (with respect to the spherity assumption, handling missing data, handling continuous data), it is often recommended to use modern models such as mixed-effect models and marginal models [@Chen_2013;@Guillaume_2014;@McFarquhar_2019].
@McFarquhar_2019 demonstrated that specifying complex multi-level models and deriving the correct contrast weights with standard neuroimaging software packages such as SPM and FSL can be quite tedious and complicated if done appropriately. However, <!-- to rule out gross missspecification in the SwE model,  -->for the purpose of comparison, we re-ran the analysis for the group-time-interaction with age and sex as nuisance covariates.
<!-- (FD is time-varying... schwierig) with a simplified model without nuisance covariates in SPM12. We opted for a simplified model because different nuisance covariates, time-invariant or time-varying, create additional complications. -->
An advantage of the group-time interaction in our model is that the $F$-ratio does not require partitioning the error and includes only factors and time-invariant nuisance convariates. The model was set up as flexible factorial design with factors "subject", "group", and "time" assuming unequal group variances.
<!-- vastly different - different implicit masks? -->
Differences could be attributed to different corrections for non-spherity and assumptions on voxel covariance structures. Detailed comparisons between SPM12, SwE, and other software packages have been described elsewhere [@McFarquhar_2016].
<!-- conclusion??? -->
Opposed to flexible factorial models, where each individual is modelled separately, models are parsimonious and preserve more degrees of freedom.



<!-- IMPLICATIONS -->
<!-- Relevance of rsfMRI as biomarker -->
<!-- Consideration of head motion as covariate -->
<!-- Problem head motion -->
Based on concerns expressed in the literature [@], we tried to closely inspect and rigorously control for the influence of head motion. The presence of multicollinearity of our predictors has been established before. As described in @Monti_2011 in the presence of multicollinearity, the unique contribution of the regressor for the prediction cannot be disentangled. Confidence in $\beta$ estimates will suffers and estimates can behave erratic depending on which regressors included in the model.

<!-- For all patients included, conservative obesity treatment had failed, e.g. behavioral diet intervention. As shown before, patients who were successful in behavioral diet increased connectivity in the default mode network. This might be indicative for self-referent information processing. -->

# Code availability

All code is available in the github repository [https://github.com/hsx1/adi2_rsfmri](https://github.com/hsx1/adi2_rsfmri). The code includes script for data preparation and analysis of different models.

# Declaration of interest
# Funding
# Acknowledgments
# Author Contributions

Stud conception and design
Aqcuisiiton of data:
Analysis andinterpretation of data:
Frafting of manuscript:
Ciritical revision:

\newpage
# References

```{r Exploratory plots, eval=FALSE}
# BMI over time per group
tspag <-
  ggplot(final, aes(x = tp, y = BMI)) +
  stat_summary(
    aes(group = condition),
    fun = mean,
    geom  = "line",
    size = 2,
    color = c(rep("#00305E", 3), rep("#C00045", 3))
  ) +
  geom_line(aes(group = subj.ID, color = condition)) +
  geom_point(aes(color = condition))
tspag +
  scale_x_discrete(labels = c("bl" = "0", "fu" = "6", "fu2" = "12")) +
  scale_color_manual(
    values = c("#00305E77", "#C0004577"),
    labels = c("intervention", "control")
  ) +
  xlab("Time after intervention [months]") + ylab ("BMI [kg/m²]") +
  theme_bw() +  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.position = "bottom",
    legend.background = element_rect(colour = "grey")
  )

# BMI over time per subject
# group x time interaction for BMI
tspag <- ggplot(final, aes(
  x = tp,
  y = BMI,
  color = condition,
  group = condition
)) +
  geom_point() +

  stat_summary(fun = mean, geom = "point") +
  stat_summary(fun = mean, geom = "line")
tspag  +
  scale_color_manual(values = c("#00305E", "#C00045")) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    strip.text = element_text(size = 12),
    legend.position = "top"
)
```

```{r expample plots, eval=FALSE}

df_wide <- tidyr::pivot_wider(
  data = final,
  id_cols = "subj.ID",
  names_from = "tp",
  values_from = c("tp", "BMI", "logmFD")
)

if (tp == "BLFU") {
  s = 2
} else {
  s = 1
}

BMI_vector <- c("BMI_fu2", "BMI_fu", "BMI_bl")
BMI_vector <- c("BMI_bl", "BMI_fu", "BMI_fu2")
FD_vector <- c("logmFD_fu2", "logmFD_fu", "logmFD_bl")
df_wide$avgBMI <- apply(df_wide[, BMI_vector[s:3]],
                        MARGIN = 1,
                        FUN = mean,
                        na.rm = TRUE)
df_wide$avgFD <- apply(df_wide[, FD_vector[s:3]],
                       MARGIN = 1,
                       FUN = mean,
                       na.rm = TRUE)
df_long <- tidyr::pivot_longer(
  data = df_wide,
  cols = all_of(order_vector),
  # bl, fu, fu2 (maintain original order)
  # CAREFUL: Order according to dataframe df
  names_to = "tp_tp",
  values_to = "tp",
  values_drop_na = TRUE
)
all(df_long$tp == final$tp) # check if order correct

head(final[, c("subj.ID", "tp")])
head(df_long[, c("subj.ID", "tp")])

df_long$cgnBMI <- final$BMI - df_long$avgBMI
df_long$avgBMIc <-
  df_long$avgBMI - mean(df_long$avgBMI, na.rm = TRUE)
df$avgBMIc <- df_long$avgBMIc
df$cgnBMI <- df_long$cgnBMI

df_long$cgnFD <- final$logmFD - df_long$avgFD
df_long$avgFDc <-
  df_long$avgFD - mean(df_long$avgFD, na.rm = TRUE)
final$avgFDc <- df_long$avgFDc
final$cgnFD <- df_long$cgnFD


# example plots for interaction effect (arbitrary variables for illustration purposes)
ggplot(final, aes(x=tp, y=BMI, group=condition, color=condition)) +
  #geom_smooth(aes(group=condition)) +
  stat_summary(fun = mean, geom = "point", size=3, shape=15) +
  stat_summary(fun = mean, geom = "line", size=1) +
  #scale_color_brewer(values = "Set1") +
  scale_x_discrete(labels=c("bl"= "0", "fu"= "6", "fu2" = "12")) +
  scale_color_manual(values=c("#00305E","#C00045"),labels = c("intervention", "control")) +
  xlab("Time after intervention [months]") + ylab ("BMI [kg/m²]") +
  theme_bw() +  theme(
    axis.text = element_text(size = 10), axis.title = element_text(size = 12),
    strip.text = element_text(size = 12), legend.text = element_text(size = 10),
    legend.position = "bottom", legend.background = element_rect(colour = "grey"))

# example plot for change effect (purely descriptive)
getPalette = colorRampPalette(brewer.pal(9, "Set1"))
cgnplot <- ggplot(final, aes(x=a,y=logmFD, group=subj.ID)) +
  geom_line(aes(x=BMI, color=subj.ID))+
  geom_point(aes(x=BMI, color=subj.ID, shape=tp), size=3, alpha = 0.5)+
  facet_grid(. ~ condition)
cgnplot +
  labs(shape="Time after intervention [months]",labels=c("0","6","12")) +
  guides(color = FALSE, alpha=FALSE, size=FALSE) +
  scale_color_manual(values = getPalette(length(unique(final$subj.ID)))) +
  ylab("log(mean FD) (mm)") + xlab("BMI [kg/m²]") + xlim(30,55) +
  theme_bw() +  theme(
    axis.text = element_text(size = 10), axis.title = element_text(size = 12),
    strip.text = element_text(size = 12), legend.text = element_text(size = 10),
    legend.position = "bottom", legend.background = element_rect(colour = "grey"))

# example plot for change effect (purely descriptive)
tspag=ggplot(data=final, aes(y=cgnFD, x=cgnBMI, color=condition))+
  geom_point(size=2)+
  #geom_line(aes(color=subj.ID))+
  #geom_smooth(method = "lm", colour = "black", linetype = 1, fill = "mistyrose3" ) +
  xlab("within-subject BMI change [kg/m²]")+
  ylab("within-subject log mean FD change [mm]")+
  guides(alpha=FALSE, size=FALSE,
         color = guide_legend(override.aes = list(size=4))) +
  facet_grid(. ~ condition)
tspag + scale_color_manual(values=c("#00305E","#C00045")) +
  theme_bw() + theme(axis.text=element_text(colour = "black",size=10),
              axis.title=element_text(size=14),
              axis.text.x = element_text(size=12),
              axis.text.y = element_text(size=12),
              strip.text = element_text(size=14),
              legend.position="top",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14))
```
